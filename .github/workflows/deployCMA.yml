# ================================
# CMA Import Connectivity Diagnostic
# ================================

# Parameters - replace with your values
$C2M_HOST = "<C2M-HOST>"
$C2M_PORT = 6501
$C2M_API = "https://$C2M_HOST:$C2M_PORT/ouaf/rest/apis/cm/admin/migrationImport"
$USERNAME = "<C2M_USER>"
$PASSWORD = "<C2M_PASS>"

Write-Host "=== Step 1: Test network connectivity ==="
$netTest = Test-NetConnection $C2M_HOST -Port $C2M_PORT
Write-Host $netTest

if (-not $netTest.TcpTestSucceeded) {
    Write-Host "TCP connection failed â€” check firewall, VPN, or network."
    exit 1
}

Write-Host "`n=== Step 2: Test basic HTTPS reachability ==="
try {
    Invoke-WebRequest -Uri $C2M_API -Method GET -UseBasicParsing -SkipCertificateCheck
    Write-Host "GET request succeeded."
} catch {
    Write-Host "GET request failed: $_"
}

Write-Host "`n=== Step 3: Test HttpClient POST with dummy content ==="

# Force TLS 1.2
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Basic Auth
$pair = "$USERNAME`:$PASSWORD"
$encodedCreds = [Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($pair))
$authHeader = "Basic $encodedCreds"

Add-Type -AssemblyName System.Net.Http
$handler = [System.Net.Http.HttpClientHandler]::new()
$handler.ServerCertificateCustomValidationCallback = { param($sender,$cert,$chain,$errors)
    Write-Host "SSL validation callback called, errors=$errors"
    return $true
}
$client = [System.Net.Http.HttpClient]::new($handler)
$client.DefaultRequestHeaders.Authorization = [System.Net.Http.Headers.AuthenticationHeaderValue]::Parse($authHeader)
$client.DefaultRequestHeaders.Add("User-Agent","GitHubRunner/Diagnostic/1.0")

# Dummy content
$multipartContent = [System.Net.Http.MultipartFormDataContent]::new()
$dummyFileContent = [System.Net.Http.StringContent]::new("dummy")
$dummyFileContent.Headers.ContentType = [System.Net.Http.Headers.MediaTypeHeaderValue]::Parse("application/octet-stream")
$multipartContent.Add($dummyFileContent, "file", "dummy.txt")

try {
    Write-Host "Sending test POST request..."
    $response = $client.PostAsync($C2M_API, $multipartContent).Result

    if (-not $response) { throw "No response from server (HttpClient returned null)" }

    Write-Host "HTTP Status Code: $($response.StatusCode.value__)"
    $body = $response.Content.ReadAsStringAsync().Result
    Write-Host "Response body:"
    Write-Output $body
} catch {
    Write-Host "POST request failed: $_"
} finally {
    $client.Dispose()
}
